#!/bin/bash

source istio_versions.sh

printf "checking gateways pods to see if they have TLS secrets loaded in memory...\n"
echo "If you see a secret called kubernetes://foo-dot-com that is ACTIVE then the gateway DOES have access to the K8s secret."
echo "If you see a secret called kubernetes://foo-dot-com that is WARMING then the gateway DOES NOT have access to the K8s secret."
printf "\n\n"

echo "listing secrets present in ns-a gateway-a"
./istioctl-${ISTIO_VERSION} proxy-config secrets $(kubectl get po -n ns-a -l app=istio-ingressgateway -oname | tail -n 1) -n ns-a

printf "\n\n"

echo "listing secrets present in ns-b gateway-b"
./istioctl-${ISTIO_VERSION} proxy-config secrets $(kubectl get po -n ns-b -l app=istio-ingressgateway -oname | tail -n 1) -n ns-b

printf "\n\n"
echo "----------------------------------------------------------------------------------------"

printf "\ntesting TLS connectivity to gateways...\n\n"
printf "If the gateway responds with:\n curl: (22) The requested URL returned error: 404\nthen it IS terminating TLS using the K8s secret.\n\n"
printf "If the gateway responds:\n curl: (35) OpenSSL SSL_connect: Connection reset by peer in connection to foo.com:4\nthen it IS NOT terminating TLS using the K8s secret.\n\n"

echo "trying to connect via TLS to ns-a gateway-a"
curl --resolve foo.com:443:$(kubectl get svc -n ns-a gateway-a -ojsonpath='{..ip}') https://foo.com -kf

printf "\n\n"

echo "trying to connect via TLS to ns-b gateway-b"
curl --resolve foo.com:443:$(kubectl get svc -n ns-b gateway-b -ojsonpath='{..ip}') https://foo.com -kf
